<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>代理人信息查询器</title>
    <!--Let browser know website is optimized for mobile-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <style>
        #consoleDiv {
            max-height: 300px;
            overflow-y: scroll;
        }
        #resultContent{
            max-height: 800px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
<div id="resultContent"></div>
<textarea cols="100" rows="10" id="phoneInput" placeholder="请输入代理人手机号，多个用回车分开"></textarea>
<br/>
<button id="btnGo">查询</button>
<div id="consoleDiv" style="font-size: 11px;color: gray;margin: 10px;"></div>

<script src="/js/jquery.min.js"></script>
<script>
    var me = {
        init: function () {
            me.doms.btnGo.on("click", me.methods.onBtnClick)
        },
        doms: {
            resultContent: $("#resultContent"),
            phoneInput: $("#phoneInput"),
            btnGo: $("#btnGo"),
            consoleDiv: $("#consoleDiv"),
        },
        datas: {
            phones: [],
            index: 0
        },
        methods: {
            onBtnClick: function () {
                var inputContent = me.doms.phoneInput.val();
                inputContent = $.trim(inputContent);
                if (!inputContent) {
                    me.methods.log("请输入关键字");
                    return;
                }

                me.datas.phones = inputContent.split("\n");
                me.datas.index = 0;
                me.doms.resultContent.html("");
                var f = function () {
                    me.datas.index++;
                    if (me.datas.index >= me.datas.phones.length) {
                        me.methods.log("全部搜索完成");
                        return;
                    }
                    me.methods.getUserInfo(me.datas.phones[me.datas.index], f);
                };
                me.methods.getUserInfo(me.datas.phones[me.datas.index], f);

            },
            getUserInfo: function (phone, end) {

                // 先搜索手机号码的用户
                me.methods.log("搜索关键字：" + phone);
                $.ajax({
                    url: "https://api.ukuaibao.com/web/user/queryUserPageListForManage.xhtml",
                    data: "keyValue=" + phone + "&sord=desc&sidx=U_Users.createdAt&accountType=2&offset=0&limit=11&operatorId=2&operatorName=admin&isManager=1&platform=ykb&userType=4",
                    success: function (res) {
                        if (res.code == 200 && res.data.rows) {
                            if (res.data.rows.length > 0) {
                                me.methods.log("用户详情获取：" + phone);
                                // 获取用户详细信息
                                $.ajax({
                                    url: "https://api.ukuaibao.com/web/user/queryUserInfo.xhtml",
                                    data: "userId=" + res.data.rows[0].userId + "&operatorId=2&operatorName=admin&isManager=1&platform=ykb",
                                    success: function (res2) {
                                        console.log(res2);
                                        if (res2.code == 200) {
                                            me.doms.resultContent.append("<hr/><div><h3>" + res2.data.realName + " - " + res2.data.cardNumber + " - 手机：" + res2.data.phone + "</h3><div>" +
                                                "<img width='500' src='" + res2.data.cardNumberImg1 + "'/></div></div>")
                                        }
                                        end && end();
                                    },
                                    error: function (e, errStr, exc) {
                                        me.methods.log(errStr);
                                    }
                                });
                            } else {
                                // 没有数据
                                me.methods.log("关键字：" + phone + ", 无数据返回：" + JSON.stringify(res));
                                end && end();
                            }

                        } else {
                            me.methods.log("关键字:" + phone + "，搜索出错：" + JSON.stringify(res));
                            end && end();
                        }
                    },
                    error: function (e, errstr, s) {
                        me.methods.log(errstr);
                    }
                });
            },
            log: function (msg) {
                me.doms.consoleDiv.append(msg + "<br/>");
            }
        }
    };
    $(function () {
        me.init();
    });
</script>
</body>

</html>